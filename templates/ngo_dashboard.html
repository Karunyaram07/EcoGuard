{% extends 'base.html' %}
{% block title %}NGO Dashboard{% endblock %}
{% block body %}
<div class="container mt-4">
  <h3>Assignments</h3>
  <table class="table table-striped table-sm">
    <thead>
      <tr>
        <th>ID</th><th>Complaint</th><th>User Email</th><th>Category</th><th>Pincode</th><th>Status</th><th>Due</th><th>Actions</th><th>AI Verified</th>
      </tr>
    </thead>
    <tbody>
      {% for a in assignments %}
      {% set c = complaint_map.get(a.complaint_id) %}
      <tr>
        <td>{{ a.id }}</td>
        <td>#{{ c.cid if c }}<br><small>{{ c.message if c }}</small></td>
        <td>{{ c.email if c }}</td>
        <td>{{ c.category if c }}</td>
        <td>
  {{ c.pincode if c }}
  {% if c and c.pincode %}
    <a href="{{ url_for('pincode_map', pincode=c.pincode) }}" target="_blank" class="ml-1">Map</a>
  {% endif %}
</td>
        <td>{{ a.status }}</td>
        <td>{{ a.due_at }}</td>
        <td>
          {% if a.status == 'Assigned' %}
          <form method="post" action="{{ url_for('ngo_accept_assignment', assign_id=a.id) }}" style="display:inline">
            <button class="btn btn-sm btn-success">Accept</button>
          </form>
          <form method="post" action="{{ url_for('ngo_reject_assignment', assign_id=a.id) }}" style="display:inline">
            <button class="btn btn-sm btn-warning">Reject</button>
          </form>
          {% endif %}
          <form method="post" action="{{ url_for('ngo_update_status', assign_id=a.id) }}" class="mt-1">
            <div class="input-group input-group-sm">
              <select name="status" class="form-control">
                <option value="">--update status--</option>
                <option>In-Progress</option>
                <option>Resolved</option>
              </select>
              <input name="notes" class="form-control" placeholder="Notes (optional)">
              <div class="input-group-append">
                <button class="btn btn-primary btn-sm">Update</button>
              </div>
            </div>
          </form>
          <!-- Quick email to user for this assignment -->
          <form method="post" action="{{ url_for('ngo_email_user', assign_id=a.id) }}" class="mt-1">
            <div class="input-group input-group-sm">
              <input name="subject" class="form-control" placeholder="Subject (optional)">
              <input name="body" class="form-control" placeholder="Message to user">
              <button class="btn btn-outline-secondary btn-sm">Send</button>
            </div>
          </form>
        </td>
        <td>
  {% if c and c.ai_verified %}
    <span class="badge badge-success">Yes</span>
  {% else %}
    <span class="badge badge-secondary">No</span>
  {% endif %}
</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}